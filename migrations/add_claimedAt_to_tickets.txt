-- SQL Migration: Add claimedAt column to Ticket table
-- Date: 2026-01-30
-- Description: Track when a ticket was claimed by a technician
--
-- IMPORTANT: SLA now counts from claimedAt instead of createdAt
-- This change affects all SLA calculations in the system.
-- Priority order for SLA start time:
--   1. claimedAt (when technician claimed the ticket)
--   2. slaStartAt (explicit SLA start override / approval time)
--   3. createdAt (fallback to ticket creation time)

-- Add claimedAt column to Ticket table
ALTER TABLE "Ticket" ADD COLUMN "claimedAt" TIMESTAMP(3);

-- Optional: Update existing tickets to set claimedAt based on first IN_PROGRESS status
-- This sets claimedAt to the earliest activity log entry where status changed to IN_PROGRESS
-- UPDATE "Ticket" t
-- SET "claimedAt" = (
--     SELECT MIN(al."createdAt")
--     FROM "ActivityLog" al
--     WHERE al."ticketId" = t.id
--     AND al."newValue" = 'IN_PROGRESS'
--     AND al."field" = 'status'
-- )
-- WHERE t."assignedToId" IS NOT NULL
-- AND t."claimedAt" IS NULL;

-- Alternative: Set claimedAt to assignedAt if available
-- UPDATE "Ticket"
-- SET "claimedAt" = "assignedAt"
-- WHERE "assignedAt" IS NOT NULL
-- AND "claimedAt" IS NULL;
