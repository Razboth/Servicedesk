// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id             String   @id @default(cuid())
  username       String   @unique
  email          String   @unique
  name           String
  password       String?
  phone          String?
  role           UserRole @default(USER)
  branchId       String?
  supportGroupId String? // For technicians
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Account lockout and activity tracking
  loginAttempts     Int       @default(0)
  lockedAt          DateTime?
  lastLoginAttempt  DateTime?
  lastActivity      DateTime  @default(now())
  
  // Password change tracking
  mustChangePassword Boolean   @default(true)
  isFirstLogin       Boolean   @default(true)
  passwordChangedAt  DateTime?

  // Relations
  branch          Branch?          @relation(fields: [branchId], references: [id])
  supportGroup    SupportGroup?    @relation(fields: [supportGroupId], references: [id])
  createdTickets  Ticket[]         @relation("TicketCreator")
  assignedTickets Ticket[]         @relation("TicketAssignee")
  approvals       TicketApproval[]
  comments        TicketComment[]
  sessions        Session[]
  accounts        Account[]
  auditLogs       AuditLog[]
  completedTasks  TicketTask[]
  notifications   Notification[]
  createdApiKeys  ApiKey[]         @relation("ApiKeyCreatedBy")
  
  // Service usage tracking
  serviceUsage    ServiceUsage[]
  favoriteServices UserFavoriteService[]
  favoriteCategories UserFavoriteCategory[]

  // Knowledge Base relations
  knowledgeArticles KnowledgeArticle[]
  knowledgeVersions KnowledgeVersion[]
  knowledgeAttachments KnowledgeAttachment[]
  knowledgeComments KnowledgeComment[]
  ticketKnowledge TicketKnowledge[]
  knowledgeFeedback KnowledgeFeedback[]

  // Report Builder relations
  createdReports     CustomReport[] @relation("ReportCreator")
  executedReports    ReportExecution[] @relation("ReportExecutor")
  favoriteReports    ReportFavorite[] @relation("ReportFavorites")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Branch Management
model Branch {
  id               String   @id @default(cuid())
  name             String
  code             String   @unique
  address          String?
  city             String?
  province         String?
  ipAddress        String?  // Network monitoring - primary IP
  backupIpAddress  String?  // Network monitoring - backup IP
  monitoringEnabled Boolean @default(false) // Network monitoring toggle
  networkMedia     NetworkMedia? // VSAT, M2M, FO
  networkVendor    String?       // Telkom, Indosat, etc.
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  users           User[]
  tickets         Ticket[]
  atms            ATM[]
  networkIncidents NetworkIncident[]
  pingResults     NetworkPingResult[] @relation("BranchPingResults")
  
  // Service usage tracking
  serviceUsage    ServiceUsage[]

  @@map("branches")
}

// Service Catalog
model ServiceCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?
  level       Int      @default(1) // 1=Category, 2=Subcategory, 3=Item
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   ServiceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ServiceCategory[] @relation("CategoryHierarchy")
  services Service[]
  favoritedBy UserFavoriteCategory[]

  @@map("service_categories")
}

model Service {
  id               String         @id @default(cuid())
  name             String
  description      String
  helpText         String?
  categoryId       String // Legacy - will be deprecated
  subcategoryId    String?
  itemId           String?
  supportGroupId   String? // Reference to SupportGroup
  priority         TicketPriority @default(MEDIUM)
  estimatedHours   Int?           @default(4)
  slaHours         Int            @default(24)
  isActive         Boolean        @default(true)
  requiresApproval Boolean        @default(true)
  isConfidential   Boolean        @default(false)
  isKasdaService   Boolean        @default(false)

  // Default values for ticket creation
  defaultTitle               String? // Auto-populate ticket title
  defaultItilCategory        TicketCategory?      @default(INCIDENT)
  defaultIssueClassification IssueClassification?

  // 3-Tier Category Relations
  tier1CategoryId    String? // Level 1: Category
  tier2SubcategoryId String? // Level 2: Subcategory
  tier3ItemId        String? // Level 3: Item

  // SLA Configuration
  responseHours     Int?    @default(4)
  resolutionHours   Int?    @default(24)
  escalationHours   Int?    @default(48)
  businessHoursOnly Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category         ServiceCategory        @relation(fields: [categoryId], references: [id])
  supportGroup     SupportGroup?          @relation(fields: [supportGroupId], references: [id])
  tier1Category    Category?              @relation(fields: [tier1CategoryId], references: [id])
  tier2Subcategory Subcategory?           @relation(fields: [tier2SubcategoryId], references: [id])
  tier3Item        Item?                  @relation(fields: [tier3ItemId], references: [id])
  fields           ServiceField[]
  fieldTemplates   ServiceFieldTemplate[]
  tickets          Ticket[]
  slaTemplate      SLATemplate?
  taskTemplates    TaskTemplate[]
  
  // Service usage tracking
  usage            ServiceUsage[]
  favoritedBy      UserFavoriteService[]

  // Report Builder relations
  reportTemplates  ReportTemplate[]

  @@map("services")
}

model ServiceField {
  id            String    @id @default(cuid())
  serviceId     String
  name          String
  label         String
  type          FieldType
  isRequired    Boolean   @default(false)
  isUserVisible Boolean   @default(true) // false = technician-only
  placeholder   String?
  helpText      String?
  defaultValue  String?
  options       Json? // For select, radio, checkbox fields
  validation    Json? // Validation rules
  order         Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  service     Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  fieldValues TicketFieldValue[]

  @@unique([serviceId, name])
  @@map("service_fields")
}

// Field Template Management - Reusable fields across services
model FieldTemplate {
  id           String    @id @default(cuid())
  name         String    @unique // Internal name for the template
  label        String // Display label
  description  String? // Description of what this field is for
  type         FieldType
  isRequired   Boolean   @default(false)
  placeholder  String?
  helpText     String?
  defaultValue String?
  options      Json? // For select, radio, checkbox fields
  validation   Json? // Validation rules
  category     String? // Category to group templates (e.g., "Contact Info", "Technical Details")
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    String?

  // Relations
  serviceFieldTemplates ServiceFieldTemplate[]

  @@map("field_templates")
}

// Many-to-many relationship between Services and Field Templates
model ServiceFieldTemplate {
  id              String   @id @default(cuid())
  serviceId       String
  fieldTemplateId String
  order           Int      @default(0)
  isRequired      Boolean? // Override template's isRequired for this service
  isUserVisible   Boolean  @default(true) // false = technician-only
  helpText        String? // Override template's helpText for this service
  defaultValue    String? // Override template's defaultValue for this service

  // Relations
  service       Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  fieldTemplate FieldTemplate @relation(fields: [fieldTemplateId], references: [id])

  @@unique([serviceId, fieldTemplateId])
  @@map("service_field_templates")
}

// Ticket Management
model Ticket {
  id                   String               @id @default(cuid())
  ticketNumber         String               @unique
  title                String
  description          String
  category             TicketCategory       @default(INCIDENT)
  serviceId            String
  categoryId           String? // 3-tier: Level 1 Category
  subcategoryId        String? // 3-tier: Level 2 Subcategory  
  itemId               String? // 3-tier: Level 3 Item
  priority             TicketPriority       @default(MEDIUM)
  status               TicketStatus         @default(OPEN)
  createdById          String
  assignedToId         String?
  branchId             String?
  supportGroupId       String? // Reference to SupportGroup
  isConfidential       Boolean              @default(false)
  issueClassification  IssueClassification?
  rootCause            String?
  preventiveMeasures   String?
  knowledgeBaseCreated Boolean              @default(false)
  estimatedHours       Int?
  actualHours          Float?
  resolutionNotes      String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  resolvedAt           DateTime?
  closedAt             DateTime?

  // Security-related fields (optional for backward compatibility)
  securityClassification String? // "HIGH", "MEDIUM", "LOW"
  securityFindings       Json? // Store SOC findings details

  // Relations
  service       Service            @relation(fields: [serviceId], references: [id])
  supportGroup  SupportGroup?      @relation(fields: [supportGroupId], references: [id])
  createdBy     User               @relation("TicketCreator", fields: [createdById], references: [id])
  assignedTo    User?              @relation("TicketAssignee", fields: [assignedToId], references: [id])
  branch        Branch?            @relation(fields: [branchId], references: [id])
  fieldValues   TicketFieldValue[]
  comments      TicketComment[]
  attachments      TicketAttachment[]
  approvals        TicketApproval[]
  slaTracking      SLATracking[]
  auditLogs        AuditLog[]
  vendorTickets    VendorTicket[]
  tasks            TicketTask[]
  ATMIncident      ATMIncident[]
  networkIncidents NetworkIncident[]
  
  // Service usage tracking
  serviceUsage     ServiceUsage[]
  
  // Knowledge Base relations
  knowledgeArticles TicketKnowledge[]

  @@map("tickets")
}

model TicketFieldValue {
  id       String @id @default(cuid())
  ticketId String
  fieldId  String
  value    String

  // Relations
  ticket Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  field  ServiceField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([ticketId, fieldId])
  @@map("ticket_field_values")
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  userId     String
  content    String   @db.Text
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  ticket      Ticket              @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id])
  attachments CommentAttachment[]

  @@map("ticket_comments")
}

model TicketAttachment {
  id           String   @id @default(cuid())
  ticketId     String
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_attachments")
}

model CommentAttachment {
  id           String   @id @default(cuid())
  commentId    String
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())

  // Relations
  comment TicketComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_attachments")
}

// 3-Tier Category Structure
model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subcategories Subcategory[]
  services      Service[]
  knowledgeArticles KnowledgeArticle[]

  @@map("categories")
}

model Subcategory {
  id          String   @id @default(cuid())
  categoryId  String
  name        String
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  items    Item[]
  services Service[]
  knowledgeArticles KnowledgeArticle[]

  @@map("subcategories")
}

model Item {
  id            String   @id @default(cuid())
  subcategoryId String
  name          String
  description   String?
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  subcategory Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  services    Service[]
  knowledgeArticles KnowledgeArticle[]

  @@map("items")
}

// Approval Workflow
model TicketApproval {
  id         String         @id @default(cuid())
  ticketId   String
  approverId String
  status     ApprovalStatus @default(PENDING)
  reason     String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  approver User   @relation(fields: [approverId], references: [id])

  @@map("ticket_approvals")
}

// SLA Management
model SLATemplate {
  id                String   @id @default(cuid())
  serviceId         String   @unique
  responseHours     Int      @default(4)
  resolutionHours   Int      @default(24)
  escalationHours   Int      @default(48)
  businessHoursOnly Boolean  @default(true)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  service     Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slaTracking SLATracking[]

  @@map("sla_templates")
}

model SLATracking {
  id                   String    @id @default(cuid())
  ticketId             String
  slaTemplateId        String
  responseDeadline     DateTime
  resolutionDeadline   DateTime
  escalationDeadline   DateTime
  responseTime         DateTime?
  resolutionTime       DateTime?
  isResponseBreached   Boolean   @default(false)
  isResolutionBreached Boolean   @default(false)
  isEscalated          Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  ticket      Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  slaTemplate SLATemplate @relation(fields: [slaTemplateId], references: [id])

  @@map("sla_tracking")
}

// ATM Monitoring
model ATM {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  branchId  String
  ipAddress String?
  location  String?
  latitude  Float?
  longitude Float?
  networkMedia  NetworkMedia? // VSAT, M2M, FO
  networkVendor String?       // Telkom, Indosat, etc.
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  branch           Branch             @relation(fields: [branchId], references: [id])
  monitoringLogs   ATMMonitoringLog[]
  incidents        ATMIncident[]
  networkIncidents NetworkIncident[]
  pingResults      NetworkPingResult[] @relation("ATMPingResults")

  @@map("atms")
}

model ATMMonitoringLog {
  id           String    @id @default(cuid())
  atmId        String
  status       ATMStatus
  responseTime Float?
  errorMessage String?
  checkedAt    DateTime  @default(now())

  // Relations
  atm ATM @relation(fields: [atmId], references: [id], onDelete: Cascade)

  @@map("atm_monitoring_logs")
}

model ATMIncident {
  id          String           @id @default(cuid())
  atmId       String
  ticketId    String?
  type        IncidentType
  severity    IncidentSeverity
  description String
  status      IncidentStatus   @default(OPEN)
  detectedAt  DateTime         @default(now())
  resolvedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // External monitoring integration fields
  externalReferenceId String? // Reference ID from external monitoring system
  metrics             Json? // Additional metrics/data from monitoring system

  // Relations
  atm    ATM     @relation(fields: [atmId], references: [id], onDelete: Cascade)
  ticket Ticket? @relation(fields: [ticketId], references: [id])

  @@map("atm_incidents")
}

// Vendor Management
model Vendor {
  id          String   @id @default(cuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vendorTickets VendorTicket[]

  @@map("vendors")
}

model VendorTicket {
  id             String       @id @default(cuid())
  ticketId       String
  vendorId       String
  vendorTicketId String?
  status         VendorStatus @default(PENDING)
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id])

  @@map("vendor_tickets")
}

// Audit & Logging
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  ticketId  String?
  action    String
  entity    String
  entityId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user   User?   @relation(fields: [userId], references: [id])
  ticket Ticket? @relation(fields: [ticketId], references: [id])

  @@map("audit_logs")
}

model LoginAttempt {
  id            String   @id @default(cuid())
  email         String
  ipAddress     String?
  userAgent     String?
  success       Boolean
  attemptedAt   DateTime @default(now())
  lockTriggered Boolean  @default(false)
  
  @@map("login_attempts")
}

// Support Group Management
model SupportGroup {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  code        String   @unique // For backward compatibility with enum
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users    User[]
  services Service[]
  tickets  Ticket[]

  @@map("support_groups")
}

// Knowledge Base System
model KnowledgeArticle {
  id                String   @id @default(cuid())
  title             String
  slug              String   @unique
  content           String   @db.Text
  summary           String?
  status            KnowledgeStatus @default(DRAFT)
  
  // 3-Tier Category Relations
  categoryId        String?
  subcategoryId     String?
  itemId            String?
  
  // Metadata
  views             Int      @default(0)
  helpful           Int      @default(0)
  notHelpful        Int      @default(0)
  tags              String[] // Array of tags for search
  
  // Author and timestamps
  authorId          String
  publishedAt       DateTime?
  expiresAt         DateTime?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  author            User                    @relation(fields: [authorId], references: [id])
  category          Category?               @relation(fields: [categoryId], references: [id])
  subcategory       Subcategory?            @relation(fields: [subcategoryId], references: [id])
  item              Item?                   @relation(fields: [itemId], references: [id])
  versions          KnowledgeVersion[]
  attachments       KnowledgeAttachment[]
  comments          KnowledgeComment[]
  relatedTickets    TicketKnowledge[]
  feedback          KnowledgeFeedback[]

  @@index([status, isActive])
  @@index([categoryId, subcategoryId, itemId])
  @@index([publishedAt])
  @@index([views])
  @@map("knowledge_articles")
}

// Task Management
model TaskTemplate {
  id          String   @id @default(cuid())
  serviceId   String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  service Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  items   TaskTemplateItem[]

  @@map("task_templates")
}

model TaskTemplateItem {
  id               String   @id @default(cuid())
  taskTemplateId   String
  title            String
  description      String?
  estimatedMinutes Int?     @default(30)
  order            Int      @default(0)
  isRequired       Boolean  @default(true)
  knowledgeBaseUrl String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  taskTemplate TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  ticketTasks  TicketTask[]

  @@map("task_template_items")
}

model TicketTask {
  id                 String     @id @default(cuid())
  ticketId           String
  taskTemplateItemId String
  status             TaskStatus @default(PENDING)
  startedAt          DateTime?
  completedAt        DateTime?
  actualMinutes      Int?
  notes              String?
  completedById      String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Relations
  ticket           Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  taskTemplateItem TaskTemplateItem @relation(fields: [taskTemplateItemId], references: [id])
  completedBy      User?            @relation(fields: [completedById], references: [id])

  @@unique([ticketId, taskTemplateItemId])
  @@map("ticket_tasks")
}

// Network Monitoring Models
model NetworkMonitoringLog {
  id              String   @id @default(cuid())
  entityType      String   // 'BRANCH' or 'ATM'
  entityId        String   // ID of the branch or ATM
  ipAddress       String   // IP address being monitored
  status          NetworkStatus
  responseTimeMs  Int?     // Response time in milliseconds
  packetLoss      Float?   // Packet loss percentage
  errorMessage    String?  // Error details if any
  checkedAt       DateTime @default(now())
  
  // Status change tracking
  previousStatus  NetworkStatus?
  statusChangedAt DateTime?  // When status last changed
  downSince       DateTime?  // When downtime started (for offline status)
  uptimeSeconds   Int?       // Cumulative uptime in seconds
  downtimeSeconds Int?       // Cumulative downtime in seconds
  
  @@unique([entityType, entityId])
  @@map("network_monitoring_logs")
}

model NetworkStatusHistory {
  id              String       @id @default(cuid())
  entityType      String       // 'BRANCH' or 'ATM'
  entityId        String       // ID of the branch or ATM
  ipAddress       String       // IP address that was monitored
  status          NetworkStatus
  previousStatus  NetworkStatus?
  responseTimeMs  Int?
  packetLoss      Float?
  errorMessage    String?
  duration        Int?         // How long this status lasted (in seconds)
  startedAt       DateTime     // When this status period began
  endedAt         DateTime?    // When this status period ended (null if current)
  createdAt       DateTime     @default(now())
  
  @@index([entityType, entityId, startedAt])
  @@index([status, startedAt])
  @@map("network_status_history")
}

model NetworkIncident {
  id                  String            @id @default(cuid())
  branchId            String?           // For branch network incidents
  atmId               String?           // For ATM network incidents  
  type                NetworkIncidentType
  severity            IncidentSeverity
  description         String
  status              IncidentStatus    @default(OPEN)
  ticketId            String?           // Auto-created ticket ID
  detectedAt          DateTime          @default(now())
  resolvedAt          DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  // External monitoring integration
  externalReferenceId String?
  metrics             Json?
  
  // Relations
  branch  Branch? @relation(fields: [branchId], references: [id])
  atm     ATM?    @relation(fields: [atmId], references: [id], onDelete: Cascade)
  ticket  Ticket? @relation(fields: [ticketId], references: [id])
  
  @@map("network_incidents")
}

// Network Media enum for branches and ATMs
enum NetworkMedia {
  VSAT
  M2M
  FO
}

// Enums
enum UserRole {
  USER
  TECHNICIAN
  MANAGER
  ADMIN
  SECURITY_ANALYST
}

enum TicketCategory {
  INCIDENT
  SERVICE_REQUEST
  CHANGE_REQUEST
  EVENT_REQUEST
}

enum TicketStatus {
  OPEN
  PENDING
  PENDING_APPROVAL
  APPROVED
  REJECTED
  IN_PROGRESS
  PENDING_VENDOR
  RESOLVED
  CLOSED
  CANCELLED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  EMERGENCY
}

// SupportGroup is now a model, not an enum

enum IssueClassification {
  HUMAN_ERROR
  SYSTEM_ERROR
  HARDWARE_FAILURE
  NETWORK_ISSUE
  SECURITY_INCIDENT
  DATA_ISSUE
  PROCESS_GAP
  EXTERNAL_FACTOR
}

enum FieldType {
  TEXT
  TEXTAREA
  EMAIL
  PHONE
  NUMBER
  DATE
  DATETIME
  SELECT
  MULTISELECT
  RADIO
  CHECKBOX
  FILE
  URL
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ATMStatus {
  ONLINE
  OFFLINE
  WARNING
  ERROR
  MAINTENANCE
}

enum IncidentType {
  NETWORK_DOWN
  HARDWARE_FAILURE
  SOFTWARE_ERROR
  MAINTENANCE
  SECURITY_BREACH
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum VendorStatus {
  PENDING
  SUBMITTED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum NetworkStatus {
  ONLINE
  OFFLINE
  SLOW
  TIMEOUT
  ERROR
}

enum NetworkIncidentType {
  COMMUNICATION_OFFLINE
  SLOW_CONNECTION
  PACKET_LOSS
  HIGH_LATENCY
  DNS_ISSUE
  NETWORK_CONGESTION
}

// Notification System
model Notification {
  id          String               @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?                // Additional data like ticketId, commentId, etc.
  isRead      Boolean              @default(false)
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  
  // Relations
  user        User                 @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  TICKET_CREATED
  TICKET_ASSIGNED
  TICKET_UPDATED
  TICKET_RESOLVED
  TICKET_CLOSED
  TICKET_COMMENT
  TICKET_APPROVED
  TICKET_REJECTED
  TICKET_ESCALATED
  SYSTEM_ALERT
  MENTION
}

model ApiKey {
  id            String    @id @default(cuid())
  name          String
  key           String    @unique
  hashedKey     String    @unique
  description   String?
  permissions   Json?     // Array of allowed endpoints or permissions
  isActive      Boolean   @default(true)
  expiresAt     DateTime?
  lastUsedAt    DateTime?
  usageCount    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     User      @relation("ApiKeyCreatedBy", fields: [createdById], references: [id])
  createdById   String
  
  @@index([key])
  @@index([hashedKey])
  @@index([isActive])
}

// Network Ping Result Model for monitoring
model NetworkPingResult {
  id                String            @id @default(cuid())
  entityType        String            // "BRANCH" or "ATM"
  entityId          String            // Branch or ATM id
  branchId          String?           // Direct reference for branches
  atmId             String?           // Direct reference for ATMs
  ipAddress         String            // IP address that was pinged
  ipType            String            @default("PRIMARY") // "PRIMARY" or "BACKUP"
  networkMedia      NetworkMedia?     // The network media type
  networkVendor     String?           // The network vendor
  status            NetworkStatus     // ONLINE, OFFLINE, SLOW, TIMEOUT, ERROR
  responseTimeMs    Int?              // Response time in milliseconds
  packetLoss        Float?            @default(0) // Packet loss percentage (0-100)
  minRtt            Float?            // Minimum round-trip time
  maxRtt            Float?            // Maximum round-trip time
  avgRtt            Float?            // Average round-trip time
  mdev              Float?            // Mean deviation of RTT
  packetsTransmitted Int?             // Number of packets sent
  packetsReceived   Int?              // Number of packets received
  errorMessage      String?           // Error details if any
  checkedAt         DateTime          @default(now())
  
  // Relations
  branch  Branch? @relation("BranchPingResults", fields: [branchId], references: [id])
  atm     ATM?    @relation("ATMPingResults", fields: [atmId], references: [id], onDelete: Cascade)
  
  @@index([entityType, entityId])
  @@index([checkedAt])
  @@index([status])
  @@map("network_ping_results")
}

// Service Usage Tracking for Analytics
model ServiceUsage {
  id        String   @id @default(cuid())
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  
  usedAt    DateTime @default(now())
  
  @@index([serviceId, usedAt])
  @@index([userId, serviceId])
  @@index([branchId, serviceId])
  @@index([usedAt])
  @@map("service_usage")
}

// User Favorite Services
model UserFavoriteService {
  id         String   @id @default(cuid())
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  lastUsedAt DateTime @updatedAt
  isPinned   Boolean  @default(false) // User can pin favorites to top
  order      Int      @default(0)     // Custom ordering
  createdAt  DateTime @default(now())
  
  @@unique([userId, serviceId])
  @@index([userId, lastUsedAt])
  @@index([userId, isPinned, order])
  @@map("user_favorite_services")
}

// User Favorite Categories
model UserFavoriteCategory {
  id         String   @id @default(cuid())
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoryId String
  category   ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  order      Int      @default(0)     // Custom ordering
  createdAt  DateTime @default(now())
  
  @@unique([userId, categoryId])
  @@index([userId, order])
  @@map("user_favorite_categories")
}


model KnowledgeVersion {
  id              String   @id @default(cuid())
  articleId       String
  version         Int
  title           String
  content         String   @db.Text
  summary         String?
  changeNotes     String?  // Version comment/notes
  authorId        String
  createdAt       DateTime @default(now())
  
  // Relations
  article         KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  author          User             @relation(fields: [authorId], references: [id])

  @@unique([articleId, version])
  @@index([articleId, createdAt])
  @@map("knowledge_versions")
}

model KnowledgeAttachment {
  id              String   @id @default(cuid())
  articleId       String
  filename        String
  originalName    String
  mimeType        String
  size            Int
  path            String
  version         Int      @default(1)
  uploadedBy      String
  createdAt       DateTime @default(now())
  
  // Relations
  article         KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  uploader        User             @relation(fields: [uploadedBy], references: [id])

  @@index([articleId])
  @@map("knowledge_attachments")
}

model KnowledgeComment {
  id              String   @id @default(cuid())
  articleId       String
  userId          String
  content         String   @db.Text
  parentId        String?  // For nested comments
  isResolved      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  article         KnowledgeArticle  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id])
  parent          KnowledgeComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies         KnowledgeComment[] @relation("CommentReplies")

  @@index([articleId, parentId])
  @@index([userId])
  @@map("knowledge_comments")
}

model TicketKnowledge {
  id              String   @id @default(cuid())
  ticketId        String
  articleId       String
  linkedBy        String
  linkedAt        DateTime @default(now())
  
  // Relations
  ticket          Ticket           @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  article         KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [linkedBy], references: [id])
  
  @@unique([ticketId, articleId])
  @@index([ticketId])
  @@index([articleId])
  @@map("ticket_knowledge")
}

model KnowledgeFeedback {
  id              String   @id @default(cuid())
  articleId       String
  userId          String
  isHelpful       Boolean
  comment         String?
  createdAt       DateTime @default(now())
  
  // Relations
  article         KnowledgeArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id])
  
  @@unique([articleId, userId])
  @@index([articleId, isHelpful])
  @@map("knowledge_feedback")
}

enum KnowledgeStatus {
  DRAFT
  UNDER_REVIEW
  PUBLISHED
  ARCHIVED
  EXPIRED
}

// Report Builder Models
model CustomReport {
  id              String   @id @default(cuid())
  title           String
  description     String?
  type            ReportType
  module          String   // TICKETS, SERVICES, USERS, etc.
  configuration   Json     // Stores report configuration
  query           String?  @db.Text // SQL query for advanced reports
  columns         Json     // Selected columns configuration
  filters         Json     // Filter criteria
  groupBy         String[]
  orderBy         Json
  chartConfig     Json?    // Chart configuration
  createdBy       String
  creator         User     @relation("ReportCreator", fields: [createdBy], references: [id])
  isPublic        Boolean  @default(false)
  category        String?  // Report category for organization
  tags            String[]
  lastRunAt       DateTime?
  runCount        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  schedules       ReportSchedule[]
  executions      ReportExecution[]
  favorites       ReportFavorite[]
  
  @@index([createdBy])
  @@index([type])
  @@index([module])
  @@map("custom_reports")
}

model ReportSchedule {
  id              String   @id @default(cuid())
  reportId        String
  report          CustomReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  frequency       ScheduleFrequency
  scheduleTime    String   // Cron expression or time
  nextRunAt       DateTime
  lastRunAt       DateTime?
  format          ExportFormat
  recipients      String[] // Email addresses
  emailSubject    String?
  emailBody       String?  @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([reportId])
  @@index([nextRunAt])
  @@map("report_schedules")
}

model ReportExecution {
  id              String   @id @default(cuid())
  reportId        String
  report          CustomReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  executedBy      String?
  executor        User?    @relation("ReportExecutor", fields: [executedBy], references: [id])
  status          ExecutionStatus
  resultCount     Int?
  executionTime   Int?     // in milliseconds
  error           String?  @db.Text
  resultPath      String?  // Path to stored result file
  createdAt       DateTime @default(now())
  
  @@index([reportId])
  @@index([executedBy])
  @@map("report_executions")
}

model ReportFavorite {
  id              String   @id @default(cuid())
  reportId        String
  report          CustomReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation("ReportFavorites", fields: [userId], references: [id])
  createdAt       DateTime @default(now())
  
  @@unique([reportId, userId])
  @@map("report_favorites")
}

model ReportTemplate {
  id              String   @id @default(cuid())
  name            String
  description     String?
  serviceId       String?  // Link to service template
  service         Service? @relation(fields: [serviceId], references: [id])
  baseQuery       String   @db.Text
  availableFields Json     // Fields available for this template
  defaultFilters  Json?
  category        String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([serviceId])
  @@map("report_templates")
}

enum ReportType {
  TABULAR
  MATRIX
  METRICS
  QUERY
}

enum ScheduleFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
}

enum ExportFormat {
  PDF
  EXCEL
  CSV
  HTML
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}
